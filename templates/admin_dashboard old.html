{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoteSafe | Admin Dashboard</title>

<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<style>
body {
    font-family: 'Public Sans', sans-serif;
    background: #f8fafc;
    margin: 0;
}
.container {
    max-width: 1200px;
    margin: auto;
    padding: 2rem;
}
.card {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
h1 { margin-bottom: 2rem; }
h2 { margin-bottom: 1rem; }

input, select {
    padding: 0.6rem;
    border-radius: 8px;
    border: 1px solid #ddd;
}
button {
    padding: 0.6rem 1rem;
    border-radius: 8px;
    border: none;
    background: #135bec;
    color: white;
    cursor: pointer;
}
button:hover { background: #0e46b8; }

table {
    width: 100%;
    border-collapse: collapse;
}
th, td {
    padding: 0.8rem;
    border-bottom: 1px solid #eee;
}
th {
    background: #f1f5f9;
    text-align: left;
}
.badge {
    background: #e0edff;
    color: #135bec;
    padding: 0.3rem 0.7rem;
    border-radius: 999px;
    font-size: 0.75rem;
}
.actions form {
    display: inline;
}
</style>
</head>
<body>
<!-- Navbar -->
<nav style="background:#135bec; color:white; padding:1rem; display:flex; gap:2rem; align-items:center;">
    <a href="" style="color:white; text-decoration:none; font-weight:bold;">ğŸ  Home</a>
    <a href="/dashboard/admin/tokens/" style="color:white; text-decoration:none; font-weight:bold;">ğŸ”‘ Manage Tokens</a>
    <a href="/statistics/" style="color:white; text-decoration:none; font-weight:bold;">ğŸ“Š Live Statistics</a>
</nav>

<div class="container" style="margin-top: 1.5rem;">
    <!-- existing content for that page -->
</div>
<div class="container">

<h1>Admin Dashboard</h1>

<!-- ğŸ“Š Live Summary -->
<div class="card">
<h2>ğŸ“Š Live Summary</h2>
<p><strong>Total Votes Cast:</strong> 
<span id="totalVotes">{{ total_votes }}</span>
</p>
<div id="leaders"></div>
</div>

<!-- ğŸ› Position Management -->
<div class="card">
<h2>Position Management</h2>

<form method="POST" style="display:flex; gap:10px; margin-bottom:1rem;">
    {% csrf_token %}
    <input type="text" name="position_name" placeholder="Position name">
    <button name="create_position">Create</button>
</form>

<h3>Existing Positions</h3>
<ul>
{% for position in positions %}
<li style="margin-bottom:0.5rem;">
    {{ position.name }}
    <form method="POST" style="display:inline;">
        {% csrf_token %}
        <button name="delete_position" value="{{ position.id }}">ğŸ—‘ Delete</button>
    </form>
</li>
{% empty %}
<li>No positions created.</li>
{% endfor %}
</ul>
</div>

<!-- ğŸ‘¤ Candidate Creation -->
<div class="card">
<h2>Create Candidate</h2>

<form method="POST" enctype="multipart/form-data" style="display:grid; gap:1rem;">
    {% csrf_token %}
    <input type="text" name="candidate_name" placeholder="Candidate name">

    <select name="candidate_position">
        {% for position in positions %}
        <option value="{{ position.id }}">{{ position.name }}</option>
        {% endfor %}
    </select>

    <input type="file" name="candidate_photo">
    <button name="create_candidate">Create</button>
</form>
</div>

<!-- ğŸ‘¥ Existing Candidates -->
<div class="card">
<h2>Existing Candidates</h2>

<table>
<tr>
<th>Name</th>
<th>Position</th>
<th>Votes</th>
<th>Managers</th>
<th>Edit</th>
</tr>

{% for candidate in candidates %}
<tr>
<td>{{ candidate.name }}</td>
<td><span class="badge">{{ candidate.position.name }}</span></td>
<td>{{ candidate.vote_count }}</td>
<td>{{ candidate.manager_count }}</td>
<td class="actions">

<form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="candidate_id" value="{{ candidate.id }}">
    <input type="text" name="candidate_name" value="{{ candidate.name }}">

    <select name="candidate_position">
        {% for position in positions %}
        <option value="{{ position.id }}"
        {% if candidate.position.id == position.id %}selected{% endif %}>
        {{ position.name }}
        </option>
        {% endfor %}
    </select>

    <input type="file" name="candidate_photo">
    <button name="edit_candidate">âœ Save</button>
</form>

</td>
</tr>

{% empty %}
<tr>
<td colspan="5" style="text-align:center; padding:2rem;">
No candidates registered.
</td>
</tr>
{% endfor %}
</table>
</div>

<!-- ğŸ”‘ Quick Links -->
<div class="card">
<a href="/dashboard/admin/tokens/">ğŸ”‘ Manage Tokens</a><br><br>
<a href="/statistics/">ğŸ“Š View Live Statistics</a>
</div>

</div>

<!-- ğŸ”„ Live Summary Refresh -->
<script>
function refreshSummary() {
    fetch("/admin/live-summary/")
    .then(response => response.json())
    .then(data => {
        document.getElementById("totalVotes").innerText = data.total_votes;

        let leaderDiv = document.getElementById("leaders");
        leaderDiv.innerHTML = "";

        data.leaders.forEach(item => {
            leaderDiv.innerHTML += 
            "<p><strong>" + item.position + "</strong>: " +
            item.leader + " (" + item.votes + " votes)</p>";
        });
    });
}

setInterval(refreshSummary, 60000);
refreshSummary();
</script>

</body>
</html>