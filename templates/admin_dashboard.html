{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoteSafe | Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">

<style>
:root {
    --primary: #135bec;
    --primary-dark: #0e46b8;
    --bg: #f6f8fc;
    --card: #ffffff;
    --border: #e6e9ef;
    --text: #1e293b;
    --muted: #64748b;
}

* {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: 'Public Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
}

/* ================= HEADER ================= */

header {
    background: white;
    border-bottom: 1px solid var(--border);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: bold;
    font-size: 1.2rem;
}

.badge-admin {
    margin-left: 10px;
    background: rgba(19,91,236,0.1);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

nav a {
    margin-left: 25px;
    text-decoration: none;
    color: var(--muted);
    font-weight: 500;
}

nav a:hover {
    color: var(--primary);
}

/* ================= LAYOUT ================= */

.container {
    max-width: 1200px;
    margin: auto;
    padding: 2rem;
}

.card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1.8rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.04);
}

.card h3 {
    margin-top: 0;
}

/* ================= FORMS ================= */

input, select {
    padding: 0.7rem 1rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    width: 100%;
}

input:focus, select:focus {
    outline: none;
    border-color: var(--primary);
}

button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 0.7rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
}

button:hover {
    background: var(--primary-dark);
}

/* ================= GRID ================= */

.grid {
    display: grid;
    gap: 2rem;
}

.grid-2 {
    grid-template-columns: 1fr 1fr;
}

@media (max-width: 768px) {
    .grid-2 {
        grid-template-columns: 1fr;
    }
}

/* ================= TABLE ================= */

table {
    width: 100%;
    border-collapse: collapse;
}

th {
    text-align: left;
    font-size: 12px;
    text-transform: uppercase;
    color: var(--muted);
    padding: 14px;
    background: #f1f5f9;
}

td {
    padding: 14px;
    border-bottom: 1px solid var(--border);
}

tr:hover {
    background: #f9fbff;
}

.position-badge {
    background: rgba(19,91,236,0.1);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 12px;
}

/* ================= SUMMARY ================= */

.summary-number {
    font-size: 2.5rem;
    font-weight: 700;
}

.leaders p {
    margin: 4px 0;
    font-size: 14px;
    color: var(--muted);
}
</style>
</head>

<body>

<header>
    <div class="logo">
        <span class="material-symbols-outlined" style="color:var(--primary)">verified_user</span>
        VoteSafe
        <span class="badge-admin">Admin Access</span>
    </div>

    <nav>
        <a href="/dashboard/admin/tokens/">Manage Tokens</a>
        <a href="/statistics/">Live Statistics</a>
    </nav>
</header>

<div class="container">

<!-- ================= LIVE SUMMARY ================= -->

<div class="card">
    <h3>Total Votes Cast</h3>
    <div class="summary-number" id="totalVotes">
        {{ total_votes }}
    </div>
    <div class="leaders" id="leaders"></div>
</div>

<!-- ================= POSITIONS ================= -->

<div class="card">
    <h3>Positions</h3>

    <form method="POST" style="display:flex; gap:10px; margin-bottom:1rem;">
        {% csrf_token %}
        <input name="position_name" placeholder="New Position">
        <button name="create_position">Create</button>
    </form>

    {% for position in positions %}
    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
        {{ position.name }}
        <form method="POST">
            {% csrf_token %}
            <button name="delete_position" value="{{ position.id }}">Delete</button>
        </form>
    </div>
    {% empty %}
    <p style="color:var(--muted)">No positions created.</p>
    {% endfor %}
</div>

<!-- ================= CREATE CANDIDATE ================= -->

<div class="card">
    <h3>Register Candidate</h3>

    <form method="POST" enctype="multipart/form-data" class="grid grid-2">
        {% csrf_token %}
        <input name="candidate_name" placeholder="Candidate Name">

        <select name="candidate_position">
            {% for position in positions %}
            <option value="{{ position.id }}">{{ position.name }}</option>
            {% endfor %}
        </select>

        <input type="file" name="candidate_photo" style="grid-column:1/-1;">

        <div style="grid-column:1/-1; text-align:right;">
            <button name="create_candidate">Add Candidate</button>
        </div>
    </form>
</div>

<!-- ================= CANDIDATE TABLE ================= -->

<div class="card">
    <h3>Candidate List</h3>

    <table>
        <thead>
            <tr>
                <th>Name</th>
                <th>Position</th>
                <th>Votes</th>
                <th>Managers</th>
                <th>Edit</th>
            </tr>
        </thead>

        <tbody>
        {% for candidate in candidates %}
        <tr>
            <td>{{ candidate.name }}</td>
            <td>
                <span class="position-badge">
                    {{ candidate.position.name }}
                </span>
            </td>
            <td>{{ candidate.vote_count }}</td>
            <td>{{ candidate.manager_count }}</td>

            <td>
                <form method="POST" enctype="multipart/form-data" style="display:flex; gap:5px;">
                    {% csrf_token %}
                    <input type="hidden" name="candidate_id" value="{{ candidate.id }}">
                    <input name="candidate_name" value="{{ candidate.name }}">
                    <select name="candidate_position">
                        {% for position in positions %}
                        <option value="{{ position.id }}"
                        {% if candidate.position.id == position.id %}selected{% endif %}>
                        {{ position.name }}
                        </option>
                        {% endfor %}
                    </select>
                    <button name="edit_candidate">Save</button>
                </form>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="5" style="text-align:center; padding:2rem; color:var(--muted);">
                No candidates registered.
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

</div>

<!-- ================= LIVE REFRESH ================= -->

<script>
function refreshSummary() {
    fetch("/admin/live-summary/")
    .then(res => res.json())
    .then(data => {
        document.getElementById("totalVotes").innerText = data.total_votes;

        let leaderDiv = document.getElementById("leaders");
        leaderDiv.innerHTML = "";

        data.leaders.forEach(item => {
            leaderDiv.innerHTML +=
            `<p><strong>${item.position}</strong>: ${item.leader} (${item.votes} votes)</p>`;
        });
    });
}

setInterval(refreshSummary, 60000);
refreshSummary();
</script>

</body>
</html>